# LLM アプリケーションの再構築仕様書

## 概要
このドキュメントは、`LLM/main.py` ファイルをモジュール化し、再利用性と保守性を向上させるための再構築仕様書です。各モジュールの役割と変更内容を詳細に記述します。

## ディレクトリ構成
再構築後のディレクトリ構成は以下の通りです。

```
LLM/
  - main.py
  - llm_factory.py
  - character_manager.py
  - llm_instance_manager.py
  - persona_manager.py
  - websocket_manager.py
  - status_manager.py
  - conversation_loop.py
  - log_manager.py
  - config.yaml
  - personas.yaml
  - logs/
  - requirements.txt
```

## 各ファイルの役割と変更内容

### 1. `main.py`
- **役割**: FastAPIアプリケーションのエントリーポイント。各モジュールを統合し、アプリケーションを起動する。
- **変更内容**:
  - 各モジュールをインポートし、初期化する。
  - WebSocketエンドポイントを設定する。

### 2. `llm_factory.py`
- **役割**: LLMプロバイダーの登録とLLMインスタンスの生成を管理する。
- **変更内容**:
  - `PROVIDER_REGISTRY` と `LLMFactory` クラスをこのファイルに移動。
  - LLMインスタンスの生成ロジックを独立させる。

### 3. `character_manager.py`
- **役割**: キャラクターの設定と管理を行う。
- **変更内容**:
  - `CharacterManager` クラスをこのファイルに移動。
  - キャラクターの設定ファイルの読み込みと管理を担当。

### 4. `llm_instance_manager.py`
- **役割**: 各キャラクターに対応するLLMインスタンスの生成と管理を行う。
- **変更内容**:
  - `CharacterManager` クラスからLLMインスタンスの生成ロジックを分離。
  - LLMインスタンスの生成と管理を担当。

### 5. `persona_manager.py`
- **役割**: キャラクターのペルソナプロンプトの管理を行う。
- **変更内容**:
  - `CharacterManager` クラスからペルソナプロンプトの取得ロジックを分離。
  - ペルソナプロンプトの管理を担当。

### 6. `websocket_manager.py`
- **役割**: WebSocket接続の管理を行う。
- **変更内容**:
  - WebSocketエンドポイントの設定と接続管理を担当。
  - クライアントとの通信を管理。

### 7. `status_manager.py`
- **役割**: キャラクターのステータス更新を管理する。
- **変更内容**:
  - ステータス更新のロジックを独立。
  - キャラクターのステータスを一括で更新する機能を提供。

### 8. `conversation_loop.py`
- **役割**: ユーザーとキャラクター間の会話ループを管理する。
- **変更内容**:
  - 会話ループのロジックを独立。
  - ユーザーのクエリを受け取り、キャラクターの応答を生成する。

### 9. `log_manager.py`
- **役割**: ログファイルの作成、記録、読み取りを管理する。
- **変更内容**:
  - ログ管理のロジックを独立。
  - ログファイルの作成、記録、読み取りを担当。

### 10. `config.yaml`
- **役割**: キャラクターの設定を定義する。
- **変更内容**: 変更なし。

### 11. `personas.yaml`
- **役割**: キャラクターのペルソナプロンプトを定義する。
- **変更内容**: 変更なし。

### 12. `log_utils.py`
- **役割**: ログファイルのユーティリティ関数を提供する。
- **変更内容**: 変更なし。

### 13. `logs/`
- **役割**: ログファイルを保存するディレクトリ。
- **変更内容**: 変更なし。

### 14. `requirements.txt`
- **役割**: 必要なPythonパッケージを定義する。
- **変更内容**: 変更なし。

## 再構築の手順
1. 各モジュールに対応するファイルを作成する。
2. `main.py` から各機能を抽出し、対応するモジュールに移動する。
3. 各モジュールの初期化と統合を `main.py` で行う。
4. 各モジュールの単体テストを作成し、動作を確認する。

## 注意点
- 各モジュールのインターフェースを明確に定義し、依存関係を最小限に抑える。
- モジュール間の通信は、必要最小限のデータのみを渡すようにする。
- 各モジュールのドキュメントを整備し、使用方法を明確にする。

## 最終確認
- すべてのモジュールが正常に動作することを確認する。
- 当初の機能がすべて再現されていることを確認する。
- 各モジュールのドキュメントを整備し、使用方法を明確にする。
